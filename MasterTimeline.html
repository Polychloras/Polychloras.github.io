<!DOCTYPE html>
<html>
    <head>
        <link rel = stylesheet href="format.css">
        <script src="d3.v7.js"></script>
        
        <script>         
            const margin = ({top: 30, bottom: 30, left: 30, right: 30});
            const wind = ({width: 1500, height: 2000})
            const bar = ({graphX:100, graphY: 0, graphW: 1200, width: 20, height: 30})
        </script>

        <title>Master Timeline</title>
    </head>

    <body>
    <h1>Master Timeline</h1>
        <div id = "container"></div>
            
        <script type="module">

                var datas = [{"Country": "Argentina","Topics": ["dictatorship "],"Start": 1976,"End": 1983},
                {"Country": "Bolivia","Topics": ["military dictatorships "], "Start": 1964, "End": 1982},
                {"Country": "Brazil","Topics": [ "military dictatorship "],"Start": 1964,"End": 1985},
                {"Country": "Chile","Topics": ["pinochet dictatorship "], "Start": 1973,"End": 1990 },
                {"Country": "Colombia", "Topics": [ "internal armed conflict "],"Start": 1960,"End": 2023},
                {"Country": "Ecuador","Topics": ["state violence"," human rights violations "," political instability "],"Start": 1983,"End": 2008}
                 ]
                
                //const data = await d3.json("12Data.json")
                TimeData(datas, wind, bar)

                function TimeData(data, wind, bar){

                var graphH = d3.count(data, d=> d.Start) * (bar.height + bar.height)
                console.log(graphH)
                // Calculate max of the End year and min of the Start year
                const maxYear = d3.max(data.map(d => d.End)) + 5;
                const minYear = d3.min(data.map(d => d.Start)) - 5;

                const x = d3.scaleLinear()
                        .domain([minYear, maxYear])
                        .range([bar.graphX, bar.graphW]);
                

                const y = d3.scaleBand(data.map(d => d.Country), [0, graphH])
                        .padding(1);
                
                const svg = d3.create("svg")
                            .attr("width", wind.width)
                            .attr("height", wind.height)
                
                var years = d3.range(minYear, maxYear, 5)


                var shaderboxes = svg.append("g")
                    .selectAll("g")
                    .data(data)
                    .join(
                        enter => enter.append("rect")
                        .attr("x", bar.graphX)
                        .attr("y", (d) => y(d.Country) - (bar.height+10)/2)
                        .attr("width", bar.graphW)
                        .attr("opacity", 0.25)
                        .attr("height", bar.height + 10)
                        .attr("fill", function (d, i){ if((i) % 2 == 0){return "grey"} else {return"darkgrey"}})
                    )
                // Add a rect for each bar.
                var bars = svg.append("g")
                        .attr("fill", "steelblue")
                    .selectAll()
                    .data(data)
                    .join(
                         enter => enter.append("rect")
                        .attr("x", d => x(d.Start))
                        .attr("y", (d) => y(d.Country) - (bar.height - 5)/2)
                        .attr("height", bar.height - 5)
                        .attr("width", (d) => x(d.End) - x(d.Start))
                        .on("mouseover", function(event, d){
        
                            // Show vertical lines and dates along the timeline
                            const lineGroup = svg.append("g")
                                .attr("class", "timeline-hover")
                                .lower();

                            lineGroup.append("line")
                            .attr("x1", x(d.Start))
                            .attr("x2", x(d.Start))
                            .attr("y1", y(d.Country)) // Start from the bottom of the bar
                            .attr("y2", graphH)
                            .style("stroke", "rgba(225,0,0,0.3)");

                            lineGroup.append("line")
                            .attr("x1", x(d.End))
                            .attr("x2", x(d.End))
                            .attr("y1",  y(d.Country)) //start from the bottom of the bar
                            .attr("y2", graphH)
                            .style("stroke", "rgba(225,0,0,0.3)");

                            lineGroup.append("text")
                            .text(d.Start)
                            .attr("x", x(d.Start))
                            .attr("y", graphH + bar.height)
                            .attr("text-anchor", "middle")
                            .attr("fill", "red"); // Display Start date in red
        
                            lineGroup.append("text")
                            .text(d.End)
                            .attr("x", x(d.End))
                            .attr("y",  graphH + bar.height)
                            .attr("text-anchor", "middle")
                            .attr("fill", "red"); // Display End date in red
                        })

                        .on("mouseout", function (event, d) {
                            // Hide vertical lines and dates along the timeline
                            svg.selectAll(".timeline-hover").remove();
                        
                            // Reset the label position to original
                            const label = d3.select(this).select("text");
                        
                                label.interrupt() // Stop any active transition
                                .transition()
                                .duration(2000)
                                .ease(d3.easeQuadInOut)
                                .attr("x", originalXPosition);
                            
                        })
                    )
                
                 // Add a text for each bar.
                var bar_text = svg.append("g")
                        .attr("fill", "White")
                    .selectAll()
                    .data(data)
                    .join(
                        enter => enter.append("text")   
                        .attr("x", d =>  x(d.Start) + 10)
                        .attr("y", (d) => y(d.Country) + 5)
                        .attr("font-size", 18)   
                        .text(d=> d.Country)
                        .on("mouseover", function(event, d){
        
                            // Show vertical lines and dates along the timeline
                            const lineGroup = svg.append("g")
                                .attr("class", "timeline-hover")
                                .lower();

                            lineGroup.append("line")
                            .attr("x1", x(d.Start))
                            .attr("x2", x(d.Start))
                            .attr("y1", y(d.Country)) // Start from the bottom of the bar
                            .attr("y2", graphH)
                            .style("stroke", "rgba(225,0,0,0.3)");

                            lineGroup.append("line")
                            .attr("x1", x(d.End))
                            .attr("x2", x(d.End))
                            .attr("y1",  y(d.Country)) //start from the bottom of the bar
                            .attr("y2", graphH)
                            .style("stroke", "rgba(225,0,0,0.3)");

                            lineGroup.append("text")
                            .text(d.Start)
                            .attr("x", x(d.Start))
                            .attr("y", graphH + bar.height)
                            .attr("text-anchor", "middle")
                            .attr("fill", "red"); // Display Start date in red
        
                            lineGroup.append("text")
                            .text(d.End)
                            .attr("x", x(d.End))
                            .attr("y",  graphH + bar.height)
                            .attr("text-anchor", "middle")
                            .attr("fill", "red"); // Display End date in red
                        })

                        .on("mouseout", function (event, d) {
                            // Hide vertical lines and dates along the timeline
                            svg.selectAll(".timeline-hover").remove();
                        
                            // Reset the label position to original
                            const label = d3.select(this).select("text");
                        
                                label.interrupt() // Stop any active transition
                                .transition()
                                .duration(2000)
                                .ease(d3.easeQuadInOut)
                                .attr("x", originalXPosition);
                            
                        })
                 )
                        
                   
                // Add the x-axis and label.
               svg.append("g")
                    .attr("transform", `translate(0,${graphH})`)
                    .attr("fill", "Black")
                    .call(d3.axisBottom(x).ticks(25).tickSizeOuter(0)
                    .tickFormat(d3.format(".0f")) // Add this line to change the tick format
                    .tickSizeOuter(0)); 

                svg.append("g")
                    .attr("transform", `translate(${bar.graphX},0)`)
                    .call(d3.axisLeft(y))
                    .call(g => g.select(".domain").remove())
                    .call(g => g.append("text")
                        .attr("x", -bar.graphW)
                        .attr("y", 10)
                        .attr("fill", "currentColor"))
                
                container.append(svg.node());
            
                }
        </script>
        
    </body>
</html>