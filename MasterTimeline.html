<!DOCTYPE html>
<html>
    <head>
        <link rel = stylesheet href="format.css">
        <script src="d3.v7.js"></script>
        
        <script>         
            const margin = ({top: 30, bottom: 30, left: 30, right: 30});
            const bar = ({graphX:100, graphY: 0, graphW: 1600, width: 20, height: 30})
            const color = ({main: "teal", change: "orange"})

            var data = [{"Country": "Argentina","Topics": ["dictatorship "],"Start_Date": 1976,"End_Date": 1983},
            {"Country": "Bolivia","Topics": ["military dictatorships "], "Start_Date": 1964, "End_Date": 1982},
            {"Country": "Brazil","Topics": [ "military dictatorship "],"Start_Date": 1964,"End_Date": 1985},
            {"Country": "Chile","Topics": ["pinochet dictatorship "], "Start_Date": 1973,"End_Date": 1990 },
            {"Country": "Colombia", "Topics": [ "internal armed conflict "],"Start_Date": 1960,"End_Date": 2016},
            {"Country": "Ecuador","Topics": ["state violence"," human rights violations "," political instability "],"Start_Date": 1983,"End_Date": 2008},
            {"Country": "Argentina1","Topics": ["dictatorship "],"Start_Date": 1976,"End_Date": 1983},
            {"Country": "Argentina2","Topics": ["dictatorship "],"Start_Date": 1976,"End_Date": 1983},
            {"Country": "Argentina3","Topics": ["dictatorship "],"Start_Date": 1976,"End_Date": 1983},
            {"Country": "Argentina4","Topics": ["dictatorship "],"Start_Date": 1976,"End_Date": 1983}
             ]

        
             var featureA =[{"feature": "Country","items": ["Argentina","Bolivia","Brazil","Chile","Colombia","Ecuador","El Salvador","Panama","Paraguay","Peru","Uruguay","Venezuela"]},
             {"feature": "Topics","items": ["dictatorship ","military dictatorships ","military dictatorship ","pinochet dictatorship ","internal armed conflict ","state violence", " human rights violations "," political instability ","civil war ","stroessner dictatorship ","social crises "," bolivarian revolution "]}
            ]

    
        </script>

        <title>Master Timeline</title>
    </head>

    <body>
    <h1>Master Timeline</h1>
    <div id="change"></div>
    <div id = "container"></div>       
        <script type="module">
            

                var sort_opt = ["Sort By", "Start_Date", "End_Date", "Country"]
                var topics_map = featureA.filter(d => get_element(d, "Topics"))[0]
                
                var first = topics_map.items[0]
                topics_map.items[0] = "Countries Topic"
                topics_map.items.push(first)
            

                function get_element(value, element){
                    return (value.feature == element)
                }

                //const data = await d3.json("12Data.json")
                //const featureA = await d3.json("12Collective.json") 

                const control_bar = d3.create('div')
                .attr("width", 1000)
                .attr("height", 50)

                const navbar = control_bar.append('nav')
                
                const ctry_btn = navbar.append('ul')               
                    .selectAll()
                    .data(data)
                    .join('li')
                
                //control_bar.append(dropdown)
                const dropdown = control_bar.append("select")
                .attr("id", `sorting`)
                .attr("name", 'sorting')
   
                const svg_sort = d3.select("sorting")

                var sorting_drp = dropdown.selectAll()
                            .data(sort_opt)
                            .join(
                                enter => enter.append('option')
                            .text(d => d)
                            .attr("value", (d) => d)
                        )


                const feature = control_bar.append("select")
                        .attr("id", `feature`)
                        .attr("name", 'feature')
           
                const svg_button = d3.select("feature")
        
                var feat_drp = feature.selectAll()
                                    .data(topics_map.items)
                                    .join(
                                        enter => enter.append('option')
                                    .text(d => d)
                                    .attr("value", (d) => d)
                )
            


                const buttons = ctry_btn.append('li')

                buttons.append('a')
                    .attr("href",  d=> 'https://polychloras.github.io/' + d.Country)
                    .text(d=>d.Country)
            
                change.append(control_bar.node())

                var timeline = TimeData(data, bar)

                container.append(timeline);


                
                function TimeData(datums, bar){

                var data = d3.sort(datums, (d) => d.Start_Date)
                var graphH = d3.count(data, d=> d.Start_Date) * (bar.height + bar.height)
                // Calculate max of the End year and min of the Start_Date year
                var maxYear = d3.max(data.map(d => d.End_Date)) + 5;
                var minYear = d3.min(data.map(d => d.Start_Date)) - 5;
                const wind = ({width: bar.graphW + 2 * bar.height, height: graphH + 2 * bar.height})
                    
                
                const x = d3.scaleLinear()
                        .domain([minYear, maxYear])
                        .range([bar.graphX, bar.graphW]);

                var y = d3.scaleBand(data.map(d => d.Country), [0, wind.height])
                        .padding(1);
                
                               

                var box = d3.select("#container")
                            
                var svg = box.append('svg')
                            .attr("viewBox", [0, 0, wind.width, wind.height]) 
                
                
                var shaderboxes = svg.append("g")
                    .selectAll("g")
                    .data(data)
                    .join(
                        enter => enter.append("rect"),
                        update => update,
                        exit => exit.remove()
                    )
                    .attr("x", bar.graphX)
                    .attr("y", (d) => y(d.Country) - bar.height/2)
                    .attr("width", bar.graphW)
                    .attr("opacity", 0.25)
                    .attr("height", bar.height + 10)
                    .attr("fill", function (d, i){ if((i) % 2 == 0){return "lightgrey"} else {return"lightgrey"}})
        

                // Add a rect for each bar.
                var bars = svg.append("g")
                        .attr("fill", color.main)
                        .attr("stroke", "null")
                    .selectAll("g")
                    .data(data)
                    .join("g")

                
                var links = bars.append("a")
                    .attr("href", d => "https://polychloras.github.io/" + d.Country)

                var ind_time = links.append("rect")
                    .attr("fill", color.main)
                    .attr("stroke", "null")
                    .attr("x", d => x(d.Start_Date))
                    .attr("y", (d, i) => y(d.Country) - bar.height/4)
                    .attr("height", bar.height - 5)
                    .attr("width", (d) => x(d.End_Date) - x(d.Start_Date))           



                var txt = bars.append("text")
                        .attr("fill", "white")
                        .attr("x", d => x(d.Start_Date) + 10)
                        .attr("y", (d, i) => y(d.Country) + bar.height/4)
                        .attr("font-size", 16) 
                        .text(d=> d.Country)     
                    
                bars.on("mouseover", mouseO) 
                bars.on("mouseout", mouseL)
                bars.on("mousedown", clickdown)  
                bars.on("mouseup", clickup)
            

                // Add the x-axis and label.
               var gx = svg.append("g")
                    .attr("transform", `translate(0,${graphH + bar.height})`)
                    .attr("fill", color.main)
                    .call(d3.axisBottom(x).ticks(25).tickSizeOuter(0)
                    .tickFormat(d3.format(".0f")) // Add this line to change the tick format
                    .tickSizeOuter(0))
                   

                var gy = svg.append("g")
                    .attr("transform", `translate(${bar.graphX},0)`)
                    .call(d3.axisLeft(y))
                    .call(g => g.select(".domain").remove())
                    .call(g => g.append("text")
                        .attr("font-size", 18)
                        .attr("x", -bar.graphW)
                        .attr("y", 10)
                        .attr("fill", "currentColor"))

                      // prevent scrolling then apply the default filter
                    function filter(event) {
                            event.preventDefault();
                            return (!event.ctrlKey || event.type === 'wheel') && !event.button;
                     }
                
        
                    function mouseL(event, d, i){                  
                            // Hide vertical lines and dates along the timeline
                            svg.selectAll(".timeline-hover").remove();
                        
                            // Reset the label position to original
                            const label = d3.select(this).select("text");
                        
                                label.interrupt() // Stop any active transition
                                .transition()
                                .duration(2000)
                                .ease(d3.easeQuadInOut)
                            
                    }

                    function mouseO(event, d){
        
                        // Show vertical lines and dates along the timeline
                        const lineGroup = svg.append("g")
                            .attr("class", "timeline-hover")
                            .lower();

                        lineGroup.append("line")
                        .attr("x1", x(d.Start_Date))
                        .attr("x2", x(d.Start_Date))
                        .attr("y1", y(d.Country)) // Start from the bottom of the bar
                        .attr("y2", graphH)
                        .style("stroke", "rgba(225,0,0,0.3)");

                        lineGroup.append("line")
                        .attr("x1", x(d.End_Date))
                        .attr("x2", x(d.End_Date))
                        .attr("y1",  y(d.Country)) //start from the bottom of the bar
                        .attr("y2", graphH)
                        .style("stroke", "rgba(225,0,0,0.3)");

                        lineGroup.append("text")
                        .text(d.Start_Date)
                        .attr("x", x(d.Start_Date))
                        .attr("y", graphH + bar.height * 2)
                        .attr("text-anchor", "middle")
                        .attr("fill", color.change); // Display Start date in red
    
                        lineGroup.append("text")
                        .text(d.End_Date)
                        .attr("x", x(d.End_Date))
                        .attr("y",  graphH + bar.height * 2)
                        .attr("text-anchor", "middle")
                        .attr("fill", color.change); // Display End date in red
                    }

                    function clickdown(event, d){
                        d3.select(this).transition()
                            .attr("fill", color.change)

                    }

                    function clickup(event, d){
                        d3.select(this).transition()
                        .attr("fill", color.main)
                    }

                    function update_feat(selectedGroup, buttontype){

                        function has(d, select){
                            return d == select
                        }

                        function zoomed(event){
                            const {transform} = event;
                            g.attr("transform", transform);
                            g.attr("stroke-width", 1 / transform.k);
                        }

                        function contains(value, select){
                                var element = value.Topics
                                var bools = d3.map(element, (d) => has(d, select))
                                var bool = d3.every(bools, (x) => x == true)
                                return bool == true
                        }
                        var filterdata = datums.filter((d) => contains(d , selectedGroup))
                        var maxYear = d3.max(filterdata.map(d => d.End_Date)) + 5;
                        var minYear = d3.min(filterdata.map(d => d.Start_Date)) - 5;

                        y = d3.scaleBand(filterdata.map(d => d.Country), [0, wind.height])
                        .padding(1);

                        gy.transition()
                        .duration(500)
                        .attr("transform", `translate(${bar.graphX},0)`)
                        .call(d3.axisLeft(y))
                        .call(g => g.select(".domain").remove())

                        

                        shaderboxes
                            .data(filterdata)
                            .attr("y", (d) => y(d.Country) - bar.height/2)
                            .attr('opacity', 1)
                            .exit()
                            .attr('opacity', 0)

                        bars.data(filterdata)
                            .attr("y", (d) => y(d.Country) - bar.height/2)
                            .attr('opacity', 1)
                            .exit()
                            .attr('opacity', 0)
                        
                        links.data(filterdata)
                                .transition()
                                .duration(2000)
                                .attr("href", d => "https://polychloras.github.io/" + d.Country)
            
                        ind_time
                                .data(filterdata)
                                .transition()
                                .duration(500)
                                .attr("fill", color.main)
                                .attr("stroke", "null")
                                .attr("x", d => x(d.Start_Date))
                                .attr("y", (d, i) => y(d.Country) - bar.height/4)
                                .attr("height", bar.height - 5)
                                .attr("width", (d) => x(d.End_Date) - x(d.Start_Date))  

                        txt.data(filterdata)
                            .transition()
                            .duration(500)
                                .attr("fill", "white")
                                .attr("x", d => x(d.Start_Date) + 10)
                                .attr("y", (d, i) => y(d.Country) + bar.height/4)
                                .attr("font-size", 16) 
                                .text(d=> d.Country) 
                        
       
                    }
    

                    function update(selectedGroup){
                        data = d3.sort(datums, (d) => d[selectedGroup])

                        y = d3.scaleBand(data.map(d => d.Country), [0, wind.height])
                        .padding(1);

                        gy.transition()
                        .duration(500)
                        .attr("transform", `translate(${bar.graphX},0)`)
                        .call(d3.axisLeft(y))
                        .call(g => g.select(".domain").remove())

                        shaderboxes
                        .data(data)
                        .attr("y", (d) => y(d.Country) - bar.height/2)
                        .attr('opacity', 1)

                        bars.data(data)
                            .transition()
                            .attr('opacity', 1)

                        links.data(data)
                                .transition()
                                .duration(500)
                                .attr("href", d => "https://polychloras.github.io/" + d.Country)
                                .attr('opacity', 1)
            
                        ind_time.data(data)
                                .transition()
                                .duration(500)
                                .attr("fill", color.main)
                                .attr("stroke", "null")
                                .attr("x", d => x(d.Start_Date))
                                .attr("y", (d, i) => y(d.Country) - bar.height/4)
                                .attr("height", bar.height - 5)
                                .attr("width", (d) => x(d.End_Date) - x(d.Start_Date))  
                                .attr('opacity', 1)

                        txt.data(data)
                            .transition()
                            .duration(500)
                                .attr("fill", "white")
                                .attr("x", d => x(d.Start_Date) + 10)
                                .attr("y", (d, i) => y(d.Country) + bar.height/4)
                                .attr("font-size", 16) 
                                .text(d=> d.Country) 
                                .attr('opacity', 1)
                        

       
                    }
    
    
                    d3.select("#sorting").on('change', function(event, d){
                        const slct_optn = d3.select(this).property("value")
                        if(slct_optn != "Sort By"){
                            update(slct_optn)
                        }
                        else{
                            update('Country')
                        }
                    })

                    d3.select("#feature").on('change', function(event, d){
                        const slct_optn = d3.select(this).property("value")
                        if(slct_optn != "Countries Topic"){
                            update_feat(slct_optn)
                        }
                        else{
                            update('Country')
                        }
                    })
                    return svg.node();
               
                    }
                
        </script>
        
    </body>
</html>