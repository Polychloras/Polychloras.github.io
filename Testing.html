<!DOCTYPE html>
<html>
<head>
    <script src="d3.v7.js">
    </script>
    
</head>

<body>
    
    <div id = "container"></div>
    <script type="module">
    //https://observablehq.com/@liuyao12/timeline 
    //https://medium.com/@kj_schmidt/show-data-on-mouse-over-with-d3-js-3bf598ff8fc2
    //https://talk.observablehq.com/t/dropdown-menu-without-viewof/3068/2
            const margin = ({top: 30, bottom: 30, left: 30, right: 30});
            const wind = ({width: 1500, height: 2000})
            const bar = ({graphX:100, graphY: 0, graphW: 1200, width: 20, height: 30})
            const color = ({main: "teal", change: "orange"})
            var data = [{"Country": "Argentina","Topics": ["dictatorship "],"Start": 1976,"End": 1983},
                        {"Country": "Bolivia","Topics": ["military dictatorships "], "Start": 1964, "End": 1982},
                        {"Country": "Brazil","Topics": [ "military dictatorship "],"Start": 1964,"End": 1985},
                        {"Country": "Chile","Topics": ["pinochet dictatorship "], "Start": 1973,"End": 1990 },
                        {"Country": "Colombia", "Topics": [ "internal armed conflict "],"Start": 1960,"End": 2023},
                        {"Country": "Ecuador","Topics": ["state violence"," human rights violations "," political instability "],"Start": 1983,"End": 2008}
                    ]
            
           var datas = [0, 1, 2, 3]

           const svg = d3.create("svg")
           .attr("width", 1000)
           .attr("height", 1000)
       
           const maxYear = d3.max(data.map(d => d.End)) + 5;
           const minYear = d3.min(data.map(d => d.Start)) - 5;
           var graphH = d3.count(data, d=> d.Start) * (bar.height + bar.height)
           const x = d3.scaleLinear()
           .domain([minYear, maxYear])
           .range([bar.graphX, bar.graphW]);
   
   

            const y = d3.scaleBand(data.map(d => d.Country), [0, graphH])
                    .padding(1);

           var loca = data.map((d) => y(d.Country) - (bar.height+10)/2)
           var bar_loc = data.map((d) => y(d.Country) - (bar.height - 5)/2)
           var txt_loc = data.map((d) => y(d.Country) + 5) 
                        // Add a rect for each bar.
           var bars = svg.append("g")
                .attr("fill", color.main)
                .attr("stroke", "null")
                .selectAll("g")
                .data(data)
                .join("g")
            
            
                bars.append("rect")
                    .attr("x", d => x(d.Start))
                    .attr("y", (d, i) => bar_loc[i])
                    .attr("height", bar.height - 5)
                    .attr("width", (d) => x(d.End) - x(d.Start)) 
            
            bars.call(drag, drag(bars, svg))

           function drag (g, svg){
            return function(g, svg) {
              var x, y, free;
              g.each((d, i) => {
                d.slot = i;
              }).attr("x", d => d.slot * w);
              function dragstarted(event, d) {
                const me = d3
                    .select(this)
                    .raise()
                    .classed("active", true),
                  m = d3.pointer(event);
                x = +me.attr("x") - event.x;
                y = +me.attr("y") - event.y;
                free = d.slot;
              }
          
              function dragged(event, d, i) {
                const xx = Math.max(0, x + event.x),
                  yy = 0; //Math.max(0, y + event.y);
                d3.select(this)
                  .attr("x", (d.x = xx))
                  .attr("y", (d.y = yy));
          
                let p = Math.round(xx / w);
          
                svg.value = g.data().map(d => d.slot);
                svg.dispatchEvent(new CustomEvent("input"));
          
                if (p === d.slot) return;
          
                g.each(function(e) {
                  if (e !== d && e.slot === p) {
                    e.slot = free;
                    d.slot = free = p;
                    d3.select(this)
                      .transition()
                      .attr("x", e.slot * w);
                  }
                });
              }
          
              function dragended(event, d) {
                d.slot = free;
                d3.select(this)
                  .transition()
                  .attr("x", d.slot * w);
                free = -1;
                d3.select(this).classed("active", false);
              }
          
              const drag = d3
                .drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
          
              svg.value = g.data().map(d => d.slot);
              svg.dispatchEvent(new CustomEvent("input"));
          
              return drag(g);
            }
          }
        
          container.append(svg.node());                  


    </script>


</body>
</html>
